@using MySqlConnector;
@using System.Data.Common;
@using System.Text.Json;
@using System.Text.Json.Nodes;

@inject NavigationManager NavigationManager
@inject ILocalStorageService localStorage
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IStringLocalizer<Shared.Membership_Reminder_Dialog> Localizer

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Class="mr-2" />
            Pro Feature – Tier 1+ Required
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.body1">
                This feature is available for <strong>Pro Users</strong> with at least <strong>Tier 1</strong> membership.
            </MudText>
            
            <MudText Typo="Typo.body2">
                Tier 1 and higher memberships unlock premium features like:
            </MudText>
            
            <MudList T="string" Dense="true">
                <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                    Code-signed Windows agents
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                    Single Sign-On (SSO)
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                    Whitelabeling options
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                    Professional support
                </MudListItem>
            </MudList>
            
            <MudDivider />
            
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Your support helps us maintain and improve NetLock RMM for everyone. By upgrading, you're not just unlocking features – you're investing in the future of this open-source project.
            </MudText>
            
            <MudAlert Severity="Severity.Info" Dense="true">
                Starting at just <strong>55€/month</strong> or <strong>550€/year</strong>, Tier 1 gives you access to premium features and professional support.
            </MudAlert>
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton Size="@Size.Small" Variant="Variant.Text" Color="Color.Default" OnClick="OK">I have understood the message</MudButton>
        <MudButton Size="@Size.Small" Variant="Variant.Filled" Color="Color.Primary" Href="https://netlockrmm.com/pricing.html" Target="_blank">
            View Pricing
        </MudButton>
    </DialogActions>
</MudDialog>


@code {

    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Check if user has at least Tier 1 - if yes, close dialog automatically
        if (await HasMinimumTier())
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
    }

    private async Task<bool> HasMinimumTier()
    {
        try
        {
            // Check if license info file exists
            if (!File.Exists(Application_Paths.internal_license_info_json_path))
                return false;

            // Get license info
            var (validUntil, packageName, licensesMax, licensesHardLimit, codeSigned) = 
                await Classes.Members_Portal.Handler.Get_License_Info();

            // Check if license is valid
            bool isValid = await Classes.Members_Portal.Handler.Check_License_Valid_Status(false);
            
            if (!isValid)
                return false;

            // Check if package name indicates Tier 1 or higher
            // Package names: "Open Source", "Tier 1", "Tier 2", etc.
            if (string.IsNullOrEmpty(packageName) || packageName.Equals("Open Source", StringComparison.OrdinalIgnoreCase) || 
                packageName.Equals("Invalid", StringComparison.OrdinalIgnoreCase) || 
                packageName.Equals("Error", StringComparison.OrdinalIgnoreCase) ||
                packageName.Equals("Unknown", StringComparison.OrdinalIgnoreCase))
            {
                return false;
            }

            // If it's a Tier package, extract the tier number
            if (packageName.StartsWith("Tier ", StringComparison.OrdinalIgnoreCase))
            {
                var tierNumberStr = packageName.Substring(5).Trim();
                if (int.TryParse(tierNumberStr, out int tierNumber))
                {
                    return tierNumber >= 1;
                }
            }

            // For cloud packages (Starter, Professional, Advanced, Enterprise), they all have premium features
            if (packageName.Equals("Starter", StringComparison.OrdinalIgnoreCase) ||
                packageName.Equals("Professional", StringComparison.OrdinalIgnoreCase) ||
                packageName.Equals("Advanced", StringComparison.OrdinalIgnoreCase) ||
                packageName.Equals("Enterprise", StringComparison.OrdinalIgnoreCase) ||
                packageName.Equals("Custom", StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }

            return false;
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("Membership_Reminder_Dialog -> HasMinimumTier", "Error", ex.ToString());
            return false;
        }
    }

    private void OK()
    {
        try
        {
            string json = File.ReadAllText("appsettings.json");

            // Parse JSON into a JsonNode
            var jsonObject = JsonNode.Parse(json) as JsonObject;

            // Update the Membership_Reminder value
            if (jsonObject != null && jsonObject["Webinterface"]?["Membership_Reminder"] != null)
            {
                jsonObject["Webinterface"]["Membership_Reminder"] = false;

                // Serialize the JSON with updated values and save back to the file
                var options = new JsonSerializerOptions { WriteIndented = true };
                File.WriteAllText("appsettings.json", jsonObject.ToJsonString(options));
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("Membership_Reminder_Dialog -> OK", "Error", ex.ToString());
        }

        MudDialog.Close(DialogResult.Ok(true));
    }

    private void Cancel() => MudDialog.Cancel();
}