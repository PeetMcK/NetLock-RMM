@using MySqlConnector;
@using System.Data.Common;
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.DataProtection

@inherits LayoutComponentBase

@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject IStringLocalizer<Layout.MainLayout> Localizer
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject IDataProtectionProvider DataProtectionProvider
@inject ProtectedSessionStorage SessionStorage

<style>
    /* ===== MODERN DESIGN SYSTEM (NetLock Style) ===== */
    
    /* CSS Variables for Theme Colors */
    :root {
        --primary-color: @(GetColorString(_theme?.PaletteLight?.Primary));
        --primary-dark: @(DarkenColor(GetColorString(_theme?.PaletteLight?.Primary)));
        --primary-rgb: @(HexToRgb(GetColorString(_theme?.PaletteLight?.Primary)));
    }

    .mud-theme-dark {
        --primary-color: @(GetColorString(_theme?.PaletteDark?.Primary));
        --primary-dark: @(DarkenColor(GetColorString(_theme?.PaletteDark?.Primary)));
        --primary-rgb: @(HexToRgb(GetColorString(_theme?.PaletteDark?.Primary)));
    }
    
    /* Apply Poppins Font globally */
    * {
        font-family: 'Poppins', 'Roboto', sans-serif !important;
    }

    /* Modern AppBar styling - Let MudBlazor handle colors from palette */
    .mud-appbar {
        position: relative;
        overflow: hidden;
    }

    /* Modern Card styling */
    .mud-card {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08) !important;
    }

    .mud-theme-dark .mud-card {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }

    /* Modern Button styling */
    .mud-button-filled.mud-button-filled-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%) !important;
        box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.3) !important;
        font-weight: 600 !important;
    }

    .mud-button-filled.mud-button-filled-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(var(--primary-rgb), 0.4) !important;
    }

    /* Modern Icon Button hover effect */
    .mud-icon-button:hover {
        background-color: rgba(var(--primary-rgb), 0.1) !important;
        transform: scale(1.1);
    }

    .mud-theme-dark .mud-icon-button:hover {
        background-color: rgba(var(--primary-rgb), 0.15) !important;
    }

    /* Modern Drawer styling */
    .mud-drawer {
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.08) !important;
    }

    .mud-theme-dark .mud-drawer {
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3) !important;
    }

    /* Modern Navigation Link styling - Only hover and active effects */
    .mud-nav-link:hover {
        background-color: rgba(var(--primary-rgb), 0.08) !important;
        transform: translateX(5px);
    }

    .mud-theme-dark .mud-nav-link:hover {
        background-color: rgba(var(--primary-rgb), 0.15) !important;
    }

    .mud-nav-link.active {
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.15) 0%, rgba(var(--primary-rgb), 0.08) 100%) !important;
        border-left: 3px solid var(--primary-color) !important;
        font-weight: 600 !important;
    }

    .mud-theme-dark .mud-nav-link.active {
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.2) 0%, rgba(var(--primary-rgb), 0.1) 100%) !important;
        border-left: 3px solid var(--primary-color) !important;
    }

    /* Modern TextField styling */
    .mud-input-underline:before {
        border-bottom-color: rgba(var(--primary-rgb), 0.2) !important;
    }

    .mud-input-underline:hover:before {
        border-bottom-color: rgba(var(--primary-rgb), 0.5) !important;
    }

    .mud-input-underline:after {
        border-bottom-color: var(--primary-color) !important;
    }

    /* Modern Paper styling */
    .mud-paper {
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06) !important;
    }

    .mud-theme-dark .mud-paper {
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.25) !important;
    }

    /* Modern Table styling */
    .mud-table {
        overflow: hidden;
    }

    .mud-table-head {
        background: rgba(var(--primary-rgb), 0.05) !important;
        font-weight: 600 !important;
    }

    .mud-theme-dark .mud-table-head {
        background: rgba(var(--primary-rgb), 0.1) !important;
    }

    .mud-table-row:hover {
        background-color: rgba(var(--primary-rgb), 0.03) !important;
    }

    .mud-theme-dark .mud-table-row:hover {
        background-color: rgba(var(--primary-rgb), 0.08) !important;
    }

    /* Modern Dialog styling */
    .mud-dialog {
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12) !important;
    }

    .mud-theme-dark .mud-dialog {
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4) !important;
    }

    /* Modern Snackbar styling */
    .mud-snackbar {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12) !important;
        font-weight: 500 !important;
    }

    /* Modern Chip styling */
    .mud-chip {
        font-weight: 500 !important;
    }

    /* Modern Progress styling */
    .mud-progress-circular.mud-primary-text > svg > circle {
        stroke: var(--primary-color) !important;
    }

    .mud-theme-dark .mud-progress-circular.mud-primary-text > svg > circle {
        stroke: var(--primary-color) !important;
    }

    /* Modern Scrollbar styling */
    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(var(--primary-rgb), 0.3);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: rgba(var(--primary-rgb), 0.5);
    }

    .mud-theme-dark ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
    }

    .mud-theme-dark ::-webkit-scrollbar-thumb {
        background: rgba(var(--primary-rgb), 0.4);
    }

    .mud-theme-dark ::-webkit-scrollbar-thumb:hover {
        background: rgba(var(--primary-rgb), 0.6);
    }

    /* Modern Badge styling */
    .mud-badge-primary {
        background-color: var(--primary-color) !important;
    }

    .mud-theme-dark .mud-badge-primary {
        background-color: var(--primary-color) !important;
    }


    /* Modern Divider styling */
    .mud-divider {
        border-color: rgba(var(--primary-rgb), 0.12) !important;
    }

    .mud-theme-dark .mud-divider {
        border-color: rgba(var(--primary-rgb), 0.2) !important;
    }


    /* Modern Switch styling - keep default animations */
    .mud-switch .mud-switch-thumb {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    .mud-switch .mud-switch-track {
        transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    /* Modern Checkbox styling */
    .mud-checkbox.mud-checked .mud-button-root {
        color: var(--primary-color) !important;
    }

    .mud-theme-dark .mud-checkbox.mud-checked .mud-button-root {
        color: var(--primary-color) !important;
    }

    /* Modern Tooltip styling - Fix for Dark Mode */
    .mud-tooltip {
        background-color: rgba(97, 97, 97, 0.95) !important;
        color: #FFFFFF !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    }

    .mud-theme-dark .mud-tooltip {
        background-color: rgba(66, 66, 66, 0.95) !important;
        color: #FFFFFF !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
    }

    /* Seasonal Events - Only in AppBar */

    .seasonal-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        overflow: hidden;
    }

    /* ===== WINTER SNOWFALL ===== */
    .snowflake {
        position: absolute;
        top: -10px;
        z-index: 1;
        user-select: none;
        cursor: default;
        pointer-events: none;
        animation-name: snowfall-appbar;
        animation-timing-function: linear;
        animation-iteration-count: infinite;
        color: #fff;
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }

    @@keyframes snowfall-appbar {
        0% {
            transform: translateY(0px) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: translateY(80px) rotate(360deg);
            opacity: 0.3;
        }
    }

    .snowflake:nth-of-type(1) { left: 10%; animation-duration: 8s; animation-delay: 0s; font-size: 14px; }
    .snowflake:nth-of-type(2) { left: 20%; animation-duration: 10s; animation-delay: 1s; font-size: 16px; }
    .snowflake:nth-of-type(3) { left: 30%; animation-duration: 7s; animation-delay: 2s; font-size: 12px; }
    .snowflake:nth-of-type(4) { left: 40%; animation-duration: 11s; animation-delay: 0.5s; font-size: 15px; }
    .snowflake:nth-of-type(5) { left: 50%; animation-duration: 9s; animation-delay: 1.5s; font-size: 13px; }
    .snowflake:nth-of-type(6) { left: 60%; animation-duration: 8s; animation-delay: 3s; font-size: 14px; }
    .snowflake:nth-of-type(7) { left: 70%; animation-duration: 10s; animation-delay: 0.2s; font-size: 12px; }
    .snowflake:nth-of-type(8) { left: 80%; animation-duration: 9s; animation-delay: 2.5s; font-size: 16px; }
    .snowflake:nth-of-type(9) { left: 90%; animation-duration: 11s; animation-delay: 1.8s; font-size: 13px; }
    .snowflake:nth-of-type(10) { left: 15%; animation-duration: 10s; animation-delay: 0.8s; font-size: 15px; }

    /* ===== NEW YEAR FIREWORKS ===== */
    .firework {
        position: absolute;
        bottom: -10px;
        z-index: 1;
        user-select: none;
        cursor: default;
        pointer-events: none;
        animation-name: firework-launch;
        animation-timing-function: ease-out;
        animation-iteration-count: infinite;
        font-size: 20px;
    }

    @@keyframes firework-launch {
        0% {
            transform: translateY(0px) scale(0.5);
            opacity: 1;
        }
        50% {
            transform: translateY(-60px) scale(1);
            opacity: 1;
        }
        70% {
            transform: translateY(-60px) scale(1.5);
            opacity: 0.8;
        }
        100% {
            transform: translateY(-60px) scale(2);
            opacity: 0;
        }
    }

    .firework:nth-of-type(1) { left: 15%; animation-duration: 2s; animation-delay: 0s; }
    .firework:nth-of-type(2) { left: 30%; animation-duration: 2.5s; animation-delay: 0.3s; }
    .firework:nth-of-type(3) { left: 45%; animation-duration: 2.2s; animation-delay: 0.6s; }
    .firework:nth-of-type(4) { left: 60%; animation-duration: 2.8s; animation-delay: 0.9s; }
    .firework:nth-of-type(5) { left: 75%; animation-duration: 2.4s; animation-delay: 1.2s; }
    .firework:nth-of-type(6) { left: 85%; animation-duration: 2.6s; animation-delay: 1.5s; }
    .firework:nth-of-type(7) { left: 20%; animation-duration: 2.3s; animation-delay: 1.8s; }
    .firework:nth-of-type(8) { left: 50%; animation-duration: 2.7s; animation-delay: 2.1s; }

    /* ===== HALLOWEEN GHOSTS & BATS ===== */
    .halloween-item {
        position: absolute;
        top: 10px;
        z-index: 1;
        user-select: none;
        cursor: default;
        pointer-events: none;
        animation-name: float-across;
        animation-timing-function: linear;
        animation-iteration-count: infinite;
        font-size: 18px;
    }

    @@keyframes float-across {
        0% {
            transform: translateX(-50px) translateY(0px);
            opacity: 0;
        }
        10% {
            opacity: 1;
        }
        90% {
            opacity: 1;
        }
        100% {
            transform: translateX(calc(100vw + 50px)) translateY(-10px);
            opacity: 0;
        }
    }

    .halloween-item:nth-of-type(1) { top: 15px; animation-duration: 12s; animation-delay: 0s; }
    .halloween-item:nth-of-type(2) { top: 25px; animation-duration: 15s; animation-delay: 3s; }
    .halloween-item:nth-of-type(3) { top: 35px; animation-duration: 13s; animation-delay: 6s; }
    .halloween-item:nth-of-type(4) { top: 20px; animation-duration: 14s; animation-delay: 9s; }
    .halloween-item:nth-of-type(5) { top: 30px; animation-duration: 16s; animation-delay: 12s; }

    /* ===== EASTER EGGS ===== */
    .easter-egg {
        position: absolute;
        top: -10px;
        z-index: 1;
        user-select: none;
        cursor: default;
        pointer-events: none;
        animation-name: egg-drop;
        animation-timing-function: ease-in;
        animation-iteration-count: infinite;
        font-size: 16px;
    }

    @@keyframes egg-drop {
        0% {
            transform: translateY(0px) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: translateY(80px) rotate(180deg);
            opacity: 0.5;
        }
    }

    .easter-egg:nth-of-type(1) { left: 12%; animation-duration: 4s; animation-delay: 0s; }
    .easter-egg:nth-of-type(2) { left: 25%; animation-duration: 5s; animation-delay: 1s; }
    .easter-egg:nth-of-type(3) { left: 38%; animation-duration: 4.5s; animation-delay: 2s; }
    .easter-egg:nth-of-type(4) { left: 51%; animation-duration: 5.5s; animation-delay: 0.5s; }
    .easter-egg:nth-of-type(5) { left: 64%; animation-duration: 4.8s; animation-delay: 1.5s; }
    .easter-egg:nth-of-type(6) { left: 77%; animation-duration: 5.2s; animation-delay: 2.5s; }
    .easter-egg:nth-of-type(7) { left: 88%; animation-duration: 4.3s; animation-delay: 3s; }

    /* ===== SPRING FLOWERS ===== */
    .spring-flower {
        position: absolute;
        bottom: -10px;
        z-index: 1;
        user-select: none;
        cursor: default;
        pointer-events: none;
        animation-name: flower-grow;
        animation-timing-function: ease-out;
        animation-iteration-count: infinite;
        font-size: 18px;
    }

    @@keyframes flower-grow {
        0% {
            transform: translateY(0px) scale(0);
            opacity: 0;
        }
        50% {
            transform: translateY(-20px) scale(1);
            opacity: 1;
        }
        100% {
            transform: translateY(-40px) scale(0.8);
            opacity: 0;
        }
    }

    .spring-flower:nth-of-type(1) { left: 10%; animation-duration: 6s; animation-delay: 0s; }
    .spring-flower:nth-of-type(2) { left: 25%; animation-duration: 7s; animation-delay: 1s; }
    .spring-flower:nth-of-type(3) { left: 40%; animation-duration: 6.5s; animation-delay: 2s; }
    .spring-flower:nth-of-type(4) { left: 55%; animation-duration: 7.5s; animation-delay: 3s; }
    .spring-flower:nth-of-type(5) { left: 70%; animation-duration: 6.8s; animation-delay: 4s; }
    .spring-flower:nth-of-type(6) { left: 85%; animation-duration: 7.2s; animation-delay: 5s; }

    /* ===== AUTUMN LEAVES ===== */
    .autumn-leaf {
        position: absolute;
        top: -10px;
        z-index: 1;
        user-select: none;
        cursor: default;
        pointer-events: none;
        animation-name: leaf-fall;
        animation-timing-function: ease-in-out;
        animation-iteration-count: infinite;
        font-size: 16px;
    }

    @@keyframes leaf-fall {
        0% {
            transform: translateY(0px) translateX(0px) rotate(0deg);
            opacity: 1;
        }
        25% {
            transform: translateY(20px) translateX(10px) rotate(90deg);
        }
        50% {
            transform: translateY(40px) translateX(-5px) rotate(180deg);
        }
        75% {
            transform: translateY(60px) translateX(8px) rotate(270deg);
        }
        100% {
            transform: translateY(80px) translateX(0px) rotate(360deg);
            opacity: 0.3;
        }
    }

    .autumn-leaf:nth-of-type(1) { left: 15%; animation-duration: 8s; animation-delay: 0s; }
    .autumn-leaf:nth-of-type(2) { left: 30%; animation-duration: 10s; animation-delay: 2s; }
    .autumn-leaf:nth-of-type(3) { left: 45%; animation-duration: 9s; animation-delay: 4s; }
    .autumn-leaf:nth-of-type(4) { left: 60%; animation-duration: 11s; animation-delay: 1s; }
    .autumn-leaf:nth-of-type(5) { left: 75%; animation-duration: 9.5s; animation-delay: 3s; }
    .autumn-leaf:nth-of-type(6) { left: 85%; animation-duration: 10.5s; animation-delay: 5s; }

    /* ===== HEARTS (Valentine's Day) ===== */
    .valentine-heart {
        position: absolute;
        bottom: -10px;
        z-index: 1;
        user-select: none;
        cursor: default;
        pointer-events: none;
        animation-name: heart-float;
        animation-timing-function: ease-in-out;
        animation-iteration-count: infinite;
        font-size: 16px;
        color: #ff69b4;
    }

    @@keyframes heart-float {
        0% {
            transform: translateY(0px) scale(0.5);
            opacity: 0;
        }
        50% {
            transform: translateY(-40px) scale(1);
            opacity: 1;
        }
        100% {
            transform: translateY(-80px) scale(0.5);
            opacity: 0;
        }
    }

    .valentine-heart:nth-of-type(1) { left: 20%; animation-duration: 5s; animation-delay: 0s; }
    .valentine-heart:nth-of-type(2) { left: 40%; animation-duration: 6s; animation-delay: 1s; }
    .valentine-heart:nth-of-type(3) { left: 60%; animation-duration: 5.5s; animation-delay: 2s; }
    .valentine-heart:nth-of-type(4) { left: 80%; animation-duration: 6.5s; animation-delay: 3s; }
</style>

<MudThemeProvider Theme="@_theme" @ref="@_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" />

<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>

    <AuthorizeView>
        <Authorized>
            <MudAppBar Dense="true" Color="Color.Default" Elevation="1">
                <!-- Seasonal Events Container -->
                @if (_currentSeasonalEvent != SeasonalEvent.None)
                {
                    <div class="seasonal-container">
                        @switch (_currentSeasonalEvent)
                        {
                            case SeasonalEvent.WinterSnowfall:
                                @for (int i = 0; i < 10; i++)
                                {
                                    <div class="snowflake">‚ùÑ</div>
                                }
                                break;

                            case SeasonalEvent.NewYearFireworks:
                                @for (int i = 0; i < 8; i++)
                                {
                                    <div class="firework">üéÜ</div>
                                }
                                break;

                            case SeasonalEvent.Halloween:
                                @for (int i = 0; i < 5; i++)
                                {
                                    <div class="halloween-item">@(i % 2 == 0 ? "üëª" : "ü¶á")</div>
                                }
                                break;

                            case SeasonalEvent.Easter:
                                @for (int i = 0; i < 7; i++)
                                {
                                    <div class="easter-egg">ü•ö</div>
                                }
                                break;

                            case SeasonalEvent.Spring:
                                @for (int i = 0; i < 6; i++)
                                {
                                    <div class="spring-flower">@(new[] { "üå∏", "üå∫", "üåº", "üåª", "üå∑", "üåπ" }[i])</div>
                                }
                                break;

                            case SeasonalEvent.Autumn:
                                @for (int i = 0; i < 6; i++)
                                {
                                    <div class="autumn-leaf">üçÇ</div>
                                }
                                break;

                            case SeasonalEvent.Valentine:
                                @for (int i = 0; i < 4; i++)
                                {
                                    <div class="valentine-heart">‚ù§Ô∏è</div>
                                }
                                break;
                        }
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(NetLock_RMM_Web_Console.Configuration.Web_Console.logoBase64))
                {
                    <MudImage Src="@($"data:image/png;base64,{NetLock_RMM_Web_Console.Configuration.Web_Console.logoBase64}")" Alt="Logo" Height="35" Class="mr-3" Style="max-width: 150px; object-fit: contain;" />
                }
                else
                {
                    <MudImage Src="media/images/NetLock-RMM-Logo-Transparent.svg" Alt="Favicon" Width="35" Height="35" Class="mr-3" />
                }
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />

                <!-- Only show the title on larger screens -->
                <MudText Typo="Typo.h5" Class="ml-3 d-none d-md-flex">@NetLock_RMM_Web_Console.Configuration.Web_Console.title</MudText>

                <!-- Version for larger screens -->
                <MudText Typo="Typo.body2">
                    <MudNavLink Icon="@Icons.Material.Filled.NewReleases" Class="px-4 mud-text-secondary d-none d-md-flex" Href="@Application_Settings.versionUrl" Target="_blank">@Application_Settings.web_console_version</MudNavLink>
                </MudText>

                <MudSpacer />

                <!-- Normal icon buttons for larger screens -->
                <div class="d-none d-md-flex">
                    <MudIconButton Icon="@Icons.Material.Filled.Home" Color="Color.Inherit" Href="/home" Title="Home" />
                    <MudIconButton Icon="@Icons.Material.Filled.InstallDesktop" Color="Color.Inherit" Title="Agent Download" OnClick="Agent_Download_Dialog" />
                    <MudIconButton Icon="@(DarkLightModeButtonIcon)" Color="Color.Inherit" OnClick="@DarkModeToggle" />
                    <MudIconButton Href="https://github.com/0x101-Cyber-Security/NetLock-RMM/issues" Target="_blank" Icon="@Icons.Material.Filled.BugReport" Color="Color.Inherit" Title="@Localizer["report_a_bug"]" />
                    <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Color="Color.Inherit" Href="https://github.com/0x101-Cyber-Security/NetLock-RMM" Title="GitHub" Target="_blank" />
                    <MudIconButton Icon="@Icons.Material.Filled.MenuBook" Color="Color.Inherit" Href="https://docs.netlockrmm.com/en/home" Title="@Localizer["documentation"]" Target="_blank" />
                    <MudIconButton Icon="@Icons.Material.Filled.Support" Color="Color.Inherit" Href="https://members.netlockrmm.com/" Title="Support" Target="_blank" />
                    <MudIconButton Icon="@Icons.Custom.Brands.Discord" Color="Color.Inherit" Href="https://discord.gg/HqUpZgtX4U" Title="Discord" Target="_blank" />
                    <MudIconButton Icon="@Icons.Material.Filled.Gamepad" Color="Color.Inherit" OnClick="@OpenGameDialog" Title="Tickets open? Hah, play a game instead! :')" Target="_blank" />
                    <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Inherit" Title="@Localizer["logout"]" Href="/logout" Class="d-none d-md-flex" />
                </div>

                <!-- Dropdown menu for mobile view -->
                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Class="d-md-none">
                    <MudMenuItem OnClick="Agent_Download_Dialog">@Localizer["agent_download"]</MudMenuItem>
                    <MudMenuItem Href="https://github.com/0x101-Cyber-Security/NetLock-RMM/issues" Target="_blank">@Localizer["report_a_bug"]</MudMenuItem>
                    <MudMenuItem Href="https://github.com/0x101-Cyber-Security/NetLock-RMM" Target="_blank">GitHub</MudMenuItem>
                    <MudMenuItem Href="https://docs.netlockrmm.com/en/home" Target="_blank">@Localizer["documentation"]</MudMenuItem>
                    <MudMenuItem Href="https://members.netlockrmm.com" Target="_blank">@Localizer["support"]</MudMenuItem>
                    <MudMenuItem Href="https://discord.gg/HqUpZgtX4U" Target="_blank">Discord</MudMenuItem>
                    <MudMenuItem Href="/logout">@Localizer["logout"]</MudMenuItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Inherit"  Class="d-none d-md-flex" />
                </MudMenu>
            </MudAppBar>

            <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
                <NavMenu />
            </MudDrawer>

        </Authorized>
    </AuthorizeView>

    <MudMainContent Class="mt-16 pa-4">
        @Body
    </MudMainContent>


</MudLayout>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">üóô</a>
</div>

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;
    private MudTheme? _theme = null;
    private MudThemeProvider _mudThemeProvider;
    private SeasonalEvent _currentSeasonalEvent = SeasonalEvent.None;

    // Seasonal Event Enum
    private enum SeasonalEvent
    {
        None,
        WinterSnowfall,      // December 10 - February 28
        NewYearFireworks,    // December 28 - January 3 (Silvester/New Year)
        Valentine,           // February 10-14
        Easter,              // Easter week (calculated)
        Spring,              // March 20 - June 20
        Halloween,           // October 15 - November 1
        Autumn               // September 22 - December 9
    }

    //OSSCH_START 33d8cb08-b78e-4071-aca7-6f45eac040f5 //OSSCH_END
    
    private SeasonalEvent DetectSeasonalEvent()
    {
        var now = DateTime.Now;
        int month = now.Month;
        int day = now.Day;

        // New Year / Silvester (highest priority)
        if ((month == 12 && day >= 28) || (month == 1 && day <= 3))
            return SeasonalEvent.NewYearFireworks;

        // Valentine's Day
        if (month == 2 && day >= 10 && day <= 14)
            return SeasonalEvent.Valentine;

        // Easter (around Easter Sunday - simplified: April)
        if (month == 4 && day >= 10 && day <= 20)
            return SeasonalEvent.Easter;

        // Halloween
        if ((month == 10 && day >= 15) || (month == 11 && day == 1))
            return SeasonalEvent.Halloween;

        // Winter Snowfall (December-February, but not during New Year)
        if (month == 12 || month == 1 || month == 2)
            return SeasonalEvent.WinterSnowfall;

        // Spring
        if (month >= 3 && month <= 5)
            return SeasonalEvent.Spring;

        // Autumn
        if (month >= 9 && month <= 11)
            return SeasonalEvent.Autumn;

        return SeasonalEvent.None;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isDarkMode = await _mudThemeProvider.GetSystemPreference();

            StateHasChanged();

            //await Check_Server_Health(); // Needs rewrite
        }
    }
   
    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void DarkModeToggle()
    {
        _isDarkMode = !_isDarkMode;
    }

    private readonly PaletteLight _lightPalette = new()
    {
        // Primary Colors
        Primary = "#910012",              // NetLock RMM Primary Red
        PrimaryContrastText = "#FFFFFF",  // White text on primary
        Secondary = "#424242",            // Dark gray for secondary elements
        SecondaryContrastText = "#FFFFFF",// White text on secondary
        Tertiary = "#910012",             // Same as primary for consistency
        TertiaryContrastText = "#FFFFFF", // White text on tertiary
        
        // Background & Surface
        Background = "#F5F5F5",           // Light gray background
        BackgroundGray = "#FAFAFA",       // Slightly lighter gray
        Surface = "#FFFFFF",              // White surface for cards
        
        // AppBar & Drawer
        AppbarBackground = "rgba(255,255,255,0.8)", // Semi-transparent white
        AppbarText = "#424242",           // Dark gray text
        DrawerBackground = "#FFFFFF",     // White drawer
        DrawerText = "#424242",           // Dark gray drawer text
        DrawerIcon = "#424242",           // Dark gray drawer icons
        
        // Text Colors
        TextPrimary = "rgba(0,0,0,0.87)", // Standard dark text
        TextSecondary = "rgba(0,0,0,0.6)",// Secondary dark text
        TextDisabled = "rgba(0,0,0,0.38)",// Disabled text
        
        // Action Colors
        ActionDefault = "rgba(0,0,0,0.54)",     // Default action color
        ActionDisabled = "rgba(0,0,0,0.26)",    // Disabled actions
        ActionDisabledBackground = "rgba(0,0,0,0.12)", // Disabled background
        
        // Status Colors
        Info = "#0C80DF",                 // Blue for information
        InfoContrastText = "#FFFFFF",     // White text on info
        Success = "#00A344",              // Green for success
        SuccessContrastText = "#FFFFFF",  // White text on success
        Warning = "#D68100",              // Orange for warnings
        WarningContrastText = "#FFFFFF",  // White text on warnings
        Error = "#DC3545",                // Red for errors
        ErrorContrastText = "#FFFFFF",    // White text on errors
        Dark = "#424242",                 // Dark color
        DarkContrastText = "#FFFFFF",     // White text on dark
        
        // Lines & Dividers
        LinesDefault = "rgba(0,0,0,0.12)",// Light gray lines
        LinesInputs = "rgba(0,0,0,0.42)", // Darker lines for inputs
        Divider = "rgba(0,0,0,0.12)",     // Divider color
        DividerLight = "rgba(0,0,0,0.06)",// Light divider
        TableLines = "rgba(0,0,0,0.12)",  // Table border lines
        TableStriped = "rgba(0,0,0,0.02)",// Striped table rows
        TableHover = "rgba(0,0,0,0.04)",  // Table row hover
        
        // Gray Scale
        Black = "#000000",                // Pure black
        White = "#FFFFFF",                // Pure white
        GrayDefault = "#9E9E9E",          // Mid gray
        GrayLight = "#E0E0E0",            // Light gray
        GrayLighter = "#F5F5F5",          // Very light gray
        GrayDark = "#616161",             // Dark gray
        GrayDarker = "#424242",           // Darker gray
        
        // Overlay
        OverlayDark = "rgba(33,33,33,0.4)",  // Dark overlay for modals
        OverlayLight = "rgba(255,255,255,0.4)", // Light overlay
        
        // Hover Effects
        HoverOpacity = 0.06,              // Hover opacity
    };

    private readonly PaletteDark _darkPalette = new()
    {
        // Primary Colors
        Primary = "#ED0D32",              // NetLock RMM Bright Red
        PrimaryContrastText = "#FFFFFF",  // White text on primary
        Secondary = "#757575",            // Light gray for secondary
        SecondaryContrastText = "#FFFFFF",// White text on secondary
        Tertiary = "#ED0D32",             // Same as primary
        TertiaryContrastText = "#FFFFFF", // White text on tertiary
        
        // Background & Surface
        Background = "#0A0A0A",           // Fast schwarz
        BackgroundGray = "#121212",       // Sehr dunkel
        Surface = "#1A1A1A",              // Dunkelgrau f√ºr Cards
        
        // AppBar & Drawer
        AppbarBackground = "#1A1A1A",     // Dunkelgrau
        AppbarText = "#FFFFFF",           // White text
        DrawerBackground = "#1A1A1A",     // Dunkelgrau
        DrawerText = "#FFFFFF",           // White drawer text
        DrawerIcon = "#FFFFFF",           // White drawer icons
        
        // Text Colors
        TextPrimary = "rgba(255,255,255,0.95)", // Bright white text
        TextSecondary = "rgba(255,255,255,0.7)",// Dimmed white text
        TextDisabled = "rgba(255,255,255,0.38)",// Disabled text
        
        // Action Colors
        ActionDefault = "rgba(255,255,255,0.87)",   // Default action color
        ActionDisabled = "rgba(255,255,255,0.26)",  // Disabled actions
        ActionDisabledBackground = "rgba(255,255,255,0.12)", // Disabled background
        
        // Status Colors
        Info = "#0C80DF",                 // Blue for information
        InfoContrastText = "#FFFFFF",     // White text on info
        Success = "#00A344",              // Green for success
        SuccessContrastText = "#FFFFFF",  // White text on success
        Warning = "#D68100",              // Orange for warnings
        WarningContrastText = "#FFFFFF",  // White text on warnings
        Error = "#FF3F5F",                // Red for errors
        ErrorContrastText = "#FFFFFF",    // White text on errors
        Dark = "#1A1A1A",                 // Darker color
        DarkContrastText = "#FFFFFF",     // White text on dark
        
        // Lines & Dividers
        LinesDefault = "rgba(255,255,255,0.12)", // Subtle white lines
        LinesInputs = "rgba(255,255,255,0.3)",   // Brighter lines for inputs
        Divider = "rgba(255,255,255,0.12)",      // Divider color
        DividerLight = "rgba(255,255,255,0.06)", // Light divider
        TableLines = "rgba(255,255,255,0.12)",   // Table border lines
        TableStriped = "rgba(255,255,255,0.02)", // Striped table rows
        TableHover = "rgba(255,255,255,0.04)",   // Table row hover
        
        // Gray Scale
        Black = "#000000",                // Pure black
        White = "#FFFFFF",                // Pure white
        GrayDefault = "#757575",          // Mid gray
        GrayLight = "#616161",            // Light gray (darker in dark mode)
        GrayLighter = "#383838",          // Dunkler f√ºr besseren Kontrast
        GrayDark = "#E0E0E0",             // Dark gray (lighter in dark mode)
        GrayDarker = "#F5F5F5",           // Darker gray
        
        // Overlay
        OverlayDark = "rgba(33,33,33,0.5)",      // Dark overlay for modals
        OverlayLight = "rgba(20,20,20,0.5)",     // Dark mode light overlay
        
        // Hover Effects
        HoverOpacity = 0.08,              // Hover opacity (slightly higher for dark mode)
    };
    
    public string DarkLightModeButtonIcon => _isDarkMode switch
    {
        true => Icons.Material.Rounded.LightMode,
        false => Icons.Material.Outlined.DarkMode,
    };

    // Open Agent Download Dialog
    private async Task Agent_Download_Dialog()
    {
        var options = new DialogOptions
            {
                CloseButton = true,
                FullWidth = true,
                MaxWidth = MaxWidth.Medium,
                BackgroundClass = "dialog-blurring",
            };

        var result = await this.DialogService.Show<Layout.Agent_Download.Agent_Download_Dialog>(string.Empty, options).Result;

        if (result.Canceled)
            return;

        Logging.Handler.Debug("/MainLayout -> Event_Details_Dialog", "Result", result.Data.ToString());
    }

    // Check servers health
    private async Task Check_Server_Health()
    {
        // Check if user is authenticated
        var username = await SessionStorage.GetAsync<string>("username");
        var password = await SessionStorage.GetAsync<string>("password");
        
        if(!await Classes.Authentication.User.Verify_User(username.Value, password.Value))
            return;

        var options = new DialogOptions
            {
                CloseButton = true,
                FullWidth = true,
                MaxWidth = MaxWidth.Medium,
                BackgroundClass = "dialog-blurring",
            };

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            string query = "SELECT * FROM servers;";

            MySqlCommand cmd = new MySqlCommand(query, conn);

            Logging.Handler.Debug("/mainlayout", "Check_Server_Health", query);

            using (DbDataReader reader = await cmd.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        DateTime lastHeartbeat;

                        // Check if the last hearthbeat is older than 10 minutes
                        if (reader["docker"].ToString() == "0") // Do not check hearthbeat if running in docker because downed containers will spam the user
                        {
                            if (DateTime.TryParse(reader["hearthbeat"].ToString(), out lastHeartbeat))
                            {
                                if ((DateTime.Now - lastHeartbeat).TotalMinutes > 5)
                                {
                                    await DialogService.ShowMessageBox(
                                        Localizer["warning"],
                                        Localizer["the following netlock rmm backend server seems to be down:"]
                                        + " Name: " + reader["name"].ToString()
                                        + " " + Localizer["ip address"] + ": " + reader["ip_address"].ToString()
                                        + " " + Localizer["last hearthbeat"] + ": " + reader["hearthbeat"].ToString(),
                                        yesText: Localizer["dismiss"],
                                        options: options
                                    );
                                }
                            }
                        }

                        // Check if cpu usage is above 90%
                        if (int.TryParse(reader["cpu_usage"].ToString(), out int cpu_usage))
                        {
                            if (cpu_usage > 90)
                            {
                                await DialogService.ShowMessageBox(
                                    Localizer["warning"],
                                    Localizer["the following netlock rmm backend server seems to have high cpu usage:"]
                                    + " Name: " + reader["name"].ToString()
                                    + " " + Localizer["ip address"] + ": " + reader["ip_address"].ToString()
                                    + " " + Localizer["cpu usage"] + ": " + reader["cpu_usage"].ToString() + "%",
                                    yesText: Localizer["dismiss"],
                                    options: options
                                );
                            }
                        }

                        // Check if ram usage is above 90%
                        if (int.TryParse(reader["ram_usage"].ToString(), out int ram_usage))
                        {
                            if (ram_usage > 90)
                            {
                                await DialogService.ShowMessageBox(
                                    Localizer["warning"],
                                    Localizer["the following netlock rmm backend server seems to have high ram usage:"]
                                    + " Name: " + reader["name"].ToString()
                                    + " " + Localizer["ip address"] + ": " + reader["ip_address"].ToString()
                                    + " " + Localizer["ram usage"] + ": " + reader["ram_usage"].ToString() + "%",
                                    yesText: Localizer["dismiss"],
                                    options: options
                                );
                            }
                        }

                        // Check if disk space is below 5%
                        if (int.TryParse(reader["disk_usage"].ToString(), out int disk_space))
                        {
                            if (disk_space > 90)
                            {
                                await DialogService.ShowMessageBox(
                                    Localizer["warning"],
                                    Localizer["the following netlock rmm backend server seems to have low disk space:"]
                                    + " Name: " + reader["name"].ToString()
                                    + " " + Localizer["ip address"] + ": " + reader["ip_address"].ToString()
                                    + " " + Localizer["disk space used"] + ": " + reader["disk_usage"].ToString() + "%",
                                    yesText: Localizer["dismiss"],
                                    options: options
                                );
                            }
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/mainlayout", "Check_Server_Health", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }
    }
    
    private async Task OpenGameDialog()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            FullWidth = true,
            MaxWidth = MaxWidth.ExtraExtraLarge,
            BackgroundClass = "dialog-blurring",
        };

        var parameters = new DialogParameters
        {
        };

        DialogService.Show<Pages.Community.Events.Virus_Defense_Dialog>(String.Empty, parameters, options);
    }
    
    // Helper method to get color string from MudColor or fallback
    private string GetColorString(MudBlazor.Utilities.MudColor? color)
    {
        if (color == null || string.IsNullOrEmpty(color.Value))
        {
            // Return default based on current mode
            return _isDarkMode ? "#ED0D32" : "#910012";
        }
        return color.Value;
    }
    
    // Helper method to convert HEX to RGB for CSS variables
    private string HexToRgb(string hex)
    {
        if (string.IsNullOrEmpty(hex))
            return "145, 0, 18"; // Default fallback
            
        hex = hex.Replace("#", "");
        
        // Handle rgba() format
        if (hex.StartsWith("rgba("))
        {
            var parts = hex.Replace("rgba(", "").Replace(")", "").Split(',');
            if (parts.Length >= 3)
                return $"{parts[0].Trim()}, {parts[1].Trim()}, {parts[2].Trim()}";
        }
        
        // Handle rgb() format
        if (hex.StartsWith("rgb("))
        {
            return hex.Replace("rgb(", "").Replace(")", "");
        }
        
        try
        {
            if (hex.Length == 6)
            {
                int r = Convert.ToInt32(hex.Substring(0, 2), 16);
                int g = Convert.ToInt32(hex.Substring(2, 2), 16);
                int b = Convert.ToInt32(hex.Substring(4, 2), 16);
                return $"{r}, {g}, {b}";
            }
            else if (hex.Length == 3)
            {
                int r = Convert.ToInt32(hex.Substring(0, 1) + hex.Substring(0, 1), 16);
                int g = Convert.ToInt32(hex.Substring(1, 1) + hex.Substring(1, 1), 16);
                int b = Convert.ToInt32(hex.Substring(2, 1) + hex.Substring(2, 1), 16);
                return $"{r}, {g}, {b}";
            }
        }
        catch
        {
            return "145, 0, 18"; // Fallback on error
        }
        
        return "145, 0, 18"; // Default fallback
    }
    
    // Helper method to darken a color for gradient effects
    private string DarkenColor(string hex)
    {
        if (string.IsNullOrEmpty(hex))
            return "#b30015"; // Default fallback
            
        // If already rgba/rgb, return darker version
        if (hex.StartsWith("rgba(") || hex.StartsWith("rgb("))
            return hex; // Can't easily darken rgba/rgb strings, return as-is
            
        hex = hex.Replace("#", "");
        
        try
        {
            if (hex.Length == 6)
            {
                int r = Convert.ToInt32(hex.Substring(0, 2), 16);
                int g = Convert.ToInt32(hex.Substring(2, 2), 16);
                int b = Convert.ToInt32(hex.Substring(4, 2), 16);
                
                // Darken by 20%
                r = (int)(r * 1.2);
                g = (int)(g * 1.2);
                b = (int)(b * 1.2);
                
                // Clamp values
                r = Math.Min(255, r);
                g = Math.Min(255, g);
                b = Math.Min(255, b);
                
                return $"#{r:X2}{g:X2}{b:X2}";
            }
        }
        catch
        {
            return "#b30015"; // Fallback on error
        }
        
        return "#b30015"; // Default fallback
    }
}


