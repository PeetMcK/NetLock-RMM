@using MySqlConnector;
@using System.Text.Json;
@using System.Security.Claims

@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Duplicate Job</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body1" Class="mb-3">
            Create a duplicate of job: <strong>@OriginalJobName</strong>
        </MudText>
        <MudTextField Label="New Job Name" T="string" @bind-Value="@new_job_name" Immediate="@true" Variant="Variant.Outlined" />
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Size="@Size.Small" Color="@Color.Info" OnClick="@OK" Disabled="@Form_Valid()">
            <MudIcon Icon="@Icons.Material.Filled.ContentCopy" Class="mr-1" />
            Duplicate
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private string netlock_username = string.Empty;
    private string new_job_name = string.Empty;

    [Parameter]
    public string OriginalJobName { get; set; } = string.Empty;

    [Parameter]
    public string JobJson { get; set; } = string.Empty;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    private bool Form_Valid()
    {
        return String.IsNullOrWhiteSpace(new_job_name);
    }

    protected override async Task OnInitializedAsync()
    {
        // Get the current user from the authentication state
        var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;

        // Check if user is authenticated
        if (user?.Identity is not { IsAuthenticated: true })
        {
            NavigationManager.NavigateTo("/login", true);
            return;
        }

        // Retrieve email from claims
        netlock_username = user.FindFirst(ClaimTypes.Email)?.Value;

        // Pre-fill with original name + " (Copy)"
        new_job_name = $"{OriginalJobName} (Copy)";
    }

    private async Task OK()
    {
        if (String.IsNullOrWhiteSpace(new_job_name))
        {
            this.Snackbar.Configuration.ShowCloseIcon = true;
            this.Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            this.Snackbar.Add("Job name cannot be empty", Severity.Error);
            return;
        }

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            // Check if job name already exists
            string check_query = "SELECT COUNT(*) FROM jobs WHERE name = @name;";
            MySqlCommand check_cmd = new MySqlCommand(check_query, conn);
            check_cmd.Parameters.AddWithValue("@name", new_job_name);

            long count = (long)(await check_cmd.ExecuteScalarAsync() ?? 0);

            if (count > 0)
            {
                this.Snackbar.Configuration.ShowCloseIcon = true;
                this.Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
                this.Snackbar.Add($"Job with name '{new_job_name}' already exists", Severity.Warning);
                return;
            }

            // Read the original job from database - get the job by name since we have it
            string read_query = "SELECT * FROM jobs WHERE name = @original_name LIMIT 1;";
            MySqlCommand read_cmd = new MySqlCommand(read_query, conn);
            read_cmd.Parameters.AddWithValue("@original_name", OriginalJobName);

            string description = "";
            string platform = "";
            string type = "";
            string original_json = "";
            int? script_id = null;

            using (var reader = await read_cmd.ExecuteReaderAsync())
            {
                if (await reader.ReadAsync())
                {
                    description = reader["description"]?.ToString() ?? "";
                    platform = reader["platform"]?.ToString() ?? "";
                    type = reader["type"]?.ToString() ?? "";
                    original_json = reader["json"]?.ToString() ?? "";
                    script_id = reader["script_id"] != DBNull.Value ? Convert.ToInt32(reader["script_id"]) : null;
                }
                else
                {
                    this.Snackbar.Add("Original job not found in database", Severity.Error);
                    return;
                }
            }

            // Update the JSON with new name, author and date
            var original_job = JsonSerializer.Deserialize<JsonDocument>(original_json);
            if (original_job == null)
            {
                this.Snackbar.Add("Failed to parse job JSON", Severity.Error);
                return;
            }

            var properties = new Dictionary<string, object>();
            foreach (var prop in original_job.RootElement.EnumerateObject())
            {
                if (prop.Name == "name")
                    properties["name"] = new_job_name;
                else if (prop.Name == "author")
                    properties["author"] = netlock_username ?? "";
                else if (prop.Name == "date")
                    properties["date"] = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                else
                {
                    // Copy the property value as-is
                    properties[prop.Name] = JsonSerializer.Deserialize<object>(prop.Value.GetRawText());
                }
            }

            string new_job_json = JsonSerializer.Serialize(properties, new JsonSerializerOptions { WriteIndented = true });

            // Insert the duplicated job - copy all fields from original
            string insert_query = @"INSERT INTO jobs 
                (name, description, platform, type, script_id, json, date, author) 
                VALUES (@name, @description, @platform, @type, @script_id, @json, @date, @author);";

            MySqlCommand cmd = new MySqlCommand(insert_query, conn);
            cmd.Parameters.AddWithValue("@name", new_job_name);
            cmd.Parameters.AddWithValue("@description", description);
            cmd.Parameters.AddWithValue("@platform", platform);
            cmd.Parameters.AddWithValue("@type", type);
            cmd.Parameters.AddWithValue("@script_id", script_id.HasValue ? (object)script_id.Value : DBNull.Value);
            cmd.Parameters.AddWithValue("@json", new_job_json);
            cmd.Parameters.AddWithValue("@date", DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
            cmd.Parameters.AddWithValue("@author", netlock_username ?? "");

            int rows_affected = await cmd.ExecuteNonQueryAsync();

            if (rows_affected > 0)
            {
                this.Snackbar.Configuration.ShowCloseIcon = true;
                this.Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
                this.Snackbar.Add($"Job '{OriginalJobName}' successfully duplicated to '{new_job_name}'", Severity.Success);

                Logging.Handler.Debug("Duplicate_Job_Dialog", "Success", $"Duplicated '{OriginalJobName}' to '{new_job_name}'");

                MudDialog.Close(DialogResult.Ok(new_job_name));
            }
            else
            {
                this.Snackbar.Configuration.ShowCloseIcon = true;
                this.Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
                this.Snackbar.Add("Failed to duplicate job", Severity.Error);

                MudDialog.Close(DialogResult.Cancel());
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("Duplicate_Job_Dialog", "Error", ex.ToString());
            this.Snackbar.Configuration.ShowCloseIcon = true;
            this.Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            this.Snackbar.Add("Error duplicating job: " + ex.Message, Severity.Error);

            MudDialog.Close(DialogResult.Cancel());
        }
        finally
        {
            await conn.CloseAsync();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}

